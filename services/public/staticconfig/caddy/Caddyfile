{ # Global options block. Entirely optional, https is on by default
  email {$EMAIL} # Optional email key for lets encrypt
  #debug # this is optional; makes Caddy log more details

  admin localhost:2019
}

############
# Snippets #
############

# Navigation bar injection - adds Dashboard and Logout links via JavaScript
(navbar) {
  replace </head> "<script>document.addEventListener('DOMContentLoaded',function(){if(document.getElementById('homelab-navbar'))return;var s=document.createElement('style');s.textContent='#homelab-navbar{position:fixed;top:0;left:0;right:0;height:40px;background:#1a1a1a;display:flex;justify-content:space-between;align-items:center;padding:0 20px;z-index:999999;font-family:system-ui,sans-serif;font-size:14px;box-shadow:0 2px 4px rgba(0,0,0,0.3)}#homelab-navbar a{color:#fff;text-decoration:none;padding:8px 16px;border-radius:4px;transition:background 0.2s}#homelab-navbar a:hover{background:#333}#homelab-navbar .logout{color:#ff6b6b}body{padding-top:40px!important}';document.head.appendChild(s);var n=document.createElement('div');n.id='homelab-navbar';n.innerHTML='<a href=\"https://start.{$DOMAIN}\">‚Üê Dashboard</a><a href=\"https://auth.{$DOMAIN}/logout?rd=https://start.{$DOMAIN}\" class=\"logout\">Log Out</a>';document.body.insertBefore(n,document.body.firstChild)});</script></head>"
}

(headers) {
	header {
    -server #anonymizes Caddy

    # disable FLoC tracking
    Permissions-Policy interest-cohort=()

    # enable HSTS
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"

    # Docs | Content Security Policy https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy
    # Docs | Referrer Policy https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Referrer-Policy

    X-Content-Type-Options "nosniff" # disable clients from sniffing the media type

    # clickjacking protection
    X-Frame-Options DENY

    header_up X-Real-IP {vars.realip}
	}
}

(authelia) {
  forward_auth authelia:9091 {
    uri /api/authz/forward-auth
    copy_headers Remote-User Remote-Groups Remote-Name Remote-Email Authorization
    trusted_proxies private_ranges
  }
}

(main) {
  
  respond /robots.txt 200 {
    body "User-agent: *
    Disallow: /
    
    User-agent: AdsBot-Google
    Disallow: /

    User-agent: AdsBot-Google-Mobile
    Disallow: /"

    close
  }

  encode zstd gzip

  log {
    level ERROR
    output file {$LOG_FILE} {
      roll_size 3MiB
      roll_keep 5
      roll_keep_for 48h
    }
    format json
  }
}

############
# Routing  #
############

# import *.caddy ## try this while storing individual sites in *.caddy files

localhost {
  import main

  respond "Hello, world!"
}

{$DOMAIN} {
  import headers
  import main
  import authelia

  respond "Look at me"
}

www.{$DOMAIN} {
  redir {$DOMAIN}{uri}
}

jelly.{$DOMAIN} {
  import main
  # import navbar
  
  # Auto-redirect root to SSO (only exact "/" path, not /web/ which SSO plugin uses after login)
  # redir / /sso/OID/start/authelia
  
  # SSO plugin fix: https://github.com/9p4/jellyfin-plugin-sso/issues/200#issuecomment-2233553305
  header X-Frame-Options SAMEORIGIN

  reverse_proxy jellyfin:8096
}

# Homepage Dashboard (full version with widgets)
home.{$DOMAIN} {
  import headers
  import main
  import authelia
  import navbar

  reverse_proxy homepage:3000
}

# Simple Dashboard (Homer)
start.{$DOMAIN} {
  import headers
  import main
  import authelia

  reverse_proxy homer:8080
}

# Authelia SSO
auth.{$DOMAIN} {
  import main
  
  # Custom headers to allow Authelia to be framed by Jellyfin for SSO token exchange
  header {
    -server
    Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    X-Content-Type-Options "nosniff"
    # Allow framing by Jellyfin for SSO plugin iframe token exchange
    Content-Security-Policy "frame-ancestors 'self' https://jelly.{$DOMAIN}"
    -X-Frame-Options
  }

  reverse_proxy authelia:9091
}

# Home Assistant  
ha.{$DOMAIN} {
  import headers
  import main
  import authelia

  reverse_proxy homeassistant:8123
}

# Media Request (Jellyseerr)
request.{$DOMAIN} {
  import headers
  import main
  # import authelia
  # import navbar

  reverse_proxy jellyseerr:5055
}

# Photos (Immich)
photos.{$DOMAIN} {
  import headers
  import main
  import authelia
  # import navbar

  # Immich requires larger upload sizes for photos/videos
  request_body {
    max_size 50GB
  }

  reverse_proxy immich-server:2283
}

logs.{$DOMAIN} {
  import headers
  import main
  import authelia

  reverse_proxy dozzle:8080
}

filebrowser.{$DOMAIN} {
  import headers
  import main
  import authelia

  reverse_proxy filebrowser:80
}