---
###############################################################
#                   Authelia configuration                    #
###############################################################

theme: dark

server:
  address: 'tcp://0.0.0.0:9091/'
  
  endpoints:
    authz:
      forward-auth:
        implementation: 'ForwardAuth'

log:
  level: info
  format: text
  file_path: /config/authelia.log
  keep_stdout: true

totp:
  disable: false
  issuer: authelia.com
  algorithm: sha1
  digits: 6
  period: 30
  skew: 1
  secret_size: 32

webauthn:
  disable: false
  timeout: 60s
  display_name: Authelia
  attestation_conveyance_preference: indirect
  selection_criteria:
    user_verification: preferred

ntp:
  address: "time.cloudflare.com:123"
  version: 4
  max_desync: 3s
  disable_startup_check: false
  disable_failure: false

authentication_backend:
  password_reset:
    disable: false
  refresh_interval: 5m
  
  file:
    path: /config/users_database.yml
    password:
      algorithm: argon2id
      iterations: 3
      salt_length: 16
      parallelism: 4
      memory: 64

access_control:
  default_policy: deny
  
  rules:
    # Bypass rule for health checks
    - domain:
        - 'auth.{{ env "DOMAIN" }}'
      policy: bypass
      resources:
        - "^/api/health.*$"
    
    # Public access to auth domain
    - domain:
        - 'auth.{{ env "DOMAIN" }}'
      policy: bypass
    
    # Protected services - require authentication
    - domain:
        - '{{ env "DOMAIN" }}'
        - 'home.{{ env "DOMAIN" }}'
        - 'start.{{ env "DOMAIN" }}'
        - 'ha.{{ env "DOMAIN" }}'
        - 'jelly.{{ env "DOMAIN" }}'
        - 'request.{{ env "DOMAIN" }}'
        - 'photos.{{ env "DOMAIN" }}'
        - 'logs.{{ env "DOMAIN" }}'
      policy: two_factor

session:
  cookies:
    - name: authelia_session
      domain: '{{ env "DOMAIN" }}'
      authelia_url: 'https://auth.{{ env "DOMAIN" }}'
      same_site: lax
      expiration: 1h
      inactivity: 5m
  
  remember_me: 1M
  
  redis:
    host: authelia_redis
    port: 6379

regulation:
  max_retries: 3
  find_time: 5m
  ban_time: 30m

storage:
  encryption_key: ${AUTHELIA_ENCRYPTION_KEY}
  
  local:
    path: /config/db.sqlite3

notifier:
  disable_startup_check: false
  
  # SMTP configuration via Proton Bridge container
  # Configuration is set via environment variables in docker-compose

identity_validation:
  reset_password:
    jwt_secret: ${AUTHELIA_JWT_SECRET}

####################
# OpenID Connect Provider (SSO)
####################
identity_providers:
  oidc:
    # HMAC secret - loaded via AUTHELIA_IDENTITY_PROVIDERS_OIDC_HMAC_SECRET env var
    # RSA private key - loaded via AUTHELIA_IDENTITY_PROVIDERS_OIDC_ISSUER_PRIVATE_KEY env var
    
    # Lifespans for tokens
    lifespans:
      access_token: 1h
      authorize_code: 1m
      id_token: 1h
      refresh_token: 90m
    
    # Enable PKCE for public clients
    enforce_pkce: public_clients_only
    
    # OIDC Clients
    clients:
      # Jellyfin SSO Plugin
      - client_id: 'jellyfin'
        client_name: 'Jellyfin'
        client_secret: '{{ env "AUTHELIA_OIDC_JELLYFIN_SECRET" }}'
        public: false
        authorization_policy: 'two_factor'
        require_pkce: false
        require_pushed_authorization_requests: false
        redirect_uris:
          - 'https://jelly.{{ env "DOMAIN" }}/sso/OID/redirect/authelia'
        scopes:
          - 'openid'
          - 'profile'
          - 'groups'
          - 'email'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_post'
      
      # Jellyseerr
      - client_id: 'jellyseerr'
        client_name: 'Jellyseerr'
        client_secret: '{{ env "AUTHELIA_OIDC_JELLYSEERR_SECRET" }}'
        public: false
        authorization_policy: 'two_factor'
        require_pkce: false
        require_pushed_authorization_requests: false
        redirect_uris:
          - 'https://request.{{ env "DOMAIN" }}/api/v1/auth/oidc-callback'
        scopes:
          - 'openid'
          - 'profile'
          - 'groups'
          - 'email'
        userinfo_signed_response_alg: 'none'
        token_endpoint_auth_method: 'client_secret_post'
      
      # Home Assistant (public client)
      - client_id: 'homeassistant'
        client_name: 'Home Assistant'
        public: true
        require_pkce: true
        pkce_challenge_method: 'S256'
        authorization_policy: 'two_factor'
        require_pushed_authorization_requests: false
        redirect_uris:
          - 'https://ha.{{ env "DOMAIN" }}/auth/oidc/callback'
        scopes:
          - 'openid'
          - 'profile'
          - 'groups'
        id_token_signed_response_alg: 'RS256'
...
